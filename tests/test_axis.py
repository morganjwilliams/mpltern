import numpy as np

import pytest
import matplotlib.pyplot as plt
from matplotlib.transforms import IdentityTransform
from taxes.ternary_axis import TernaryAxis


expected = [
    ["bottom",   0, -60, "bottom"],
    ["bottom",   5, -55, "bottom"],
    ["bottom",  10, -50, "bottom"],
    ["bottom",  15, -45, "bottom"],
    ["bottom",  20, -40, "bottom"],
    ["bottom",  25, -35, "bottom"],
    ["bottom",  30, -30, "bottom"],
    ["bottom",  35, -25, "bottom"],
    ["bottom",  40, -20, "bottom"],
    ["bottom",  45, -15, "bottom"],
    ["bottom",  50, -10, "bottom"],
    ["bottom",  55,  -5, "bottom"],
    ["bottom",  60,   0, "bottom"],
    ["bottom",  65,   5, "bottom"],
    ["bottom",  70,  10, "bottom"],
    ["bottom",  75,  15, "bottom"],
    ["bottom",  80,  20, "bottom"],
    ["bottom",  85,  25, "bottom"],
    ["bottom",  90,  30, "bottom"],
    ["bottom",  95,  35, "bottom"],
    ["bottom", 100,  40, "bottom"],
    ["bottom", 105,  45, "bottom"],
    ["bottom", 110,  50, "bottom"],
    ["bottom", 115,  55, "bottom"],
    ["bottom", 120,  60, "bottom"],
    ["bottom", 125,  65, "bottom"],
    ["bottom", 130,  70, "bottom"],
    ["bottom", 135,  75, "bottom"],
    ["bottom", 140,  80, "bottom"],
    ["bottom", 145,  85, "bottom"],
    ["bottom", 150,  90, "bottom"],
    ["bottom", 155, -85, "top"],
    ["bottom", 160, -80, "top"],
    ["bottom", 165, -75, "top"],
    ["bottom", 170, -70, "top"],
    ["bottom", 175, -65, "top"],
    ["bottom", 180, -60, "top"],
    ["bottom", 185, -55, "top"],
    ["bottom", 190, -50, "top"],
    ["bottom", 195, -45, "top"],
    ["bottom", 200, -40, "top"],
    ["bottom", 205, -35, "top"],
    ["bottom", 210, -30, "top"],
    ["bottom", 215, -25, "top"],
    ["bottom", 220, -20, "top"],
    ["bottom", 225, -15, "top"],
    ["bottom", 230, -10, "top"],
    ["bottom", 235,  -5, "top"],
    ["bottom", 240,   0, "top"],
    ["bottom", 245,   5, "top"],
    ["bottom", 250,  10, "top"],
    ["bottom", 255,  15, "top"],
    ["bottom", 260,  20, "top"],
    ["bottom", 265,  25, "top"],
    ["bottom", 270,  30, "top"],
    ["bottom", 275,  35, "top"],
    ["bottom", 280,  40, "top"],
    ["bottom", 285,  45, "top"],
    ["bottom", 290,  50, "top"],
    ["bottom", 295,  55, "top"],
    ["bottom", 300,  60, "top"],
    ["bottom", 305,  65, "top"],
    ["bottom", 310,  70, "top"],
    ["bottom", 315,  75, "top"],
    ["bottom", 320,  80, "top"],
    ["bottom", 325,  85, "top"],
    ["bottom", 330, -90, "bottom"],
    ["bottom", 335, -85, "bottom"],
    ["bottom", 340, -80, "bottom"],
    ["bottom", 345, -75, "bottom"],
    ["bottom", 350, -70, "bottom"],
    ["bottom", 355, -65, "bottom"],
    ["top",   0,  60, "bottom"],
    ["top",   5,  65, "bottom"],
    ["top",  10,  70, "bottom"],
    ["top",  15,  75, "bottom"],
    ["top",  20,  80, "bottom"],
    ["top",  25,  85, "bottom"],
    ["top",  30,  90, "bottom"],
    ["top",  35, -85, "top"],
    ["top",  40, -80, "top"],
    ["top",  45, -75, "top"],
    ["top",  50, -70, "top"],
    ["top",  55, -65, "top"],
    ["top",  60, -60, "top"],
    ["top",  65, -55, "top"],
    ["top",  70, -50, "top"],
    ["top",  75, -45, "top"],
    ["top",  80, -40, "top"],
    ["top",  85, -35, "top"],
    ["top",  90, -30, "top"],
    ["top",  95, -25, "top"],
    ["top", 100, -20, "top"],
    ["top", 105, -15, "top"],
    ["top", 110, -10, "top"],
    ["top", 115,  -5, "top"],
    ["top", 120,  -0, "top"],
    ["top", 125,   5, "top"],
    ["top", 130,  10, "top"],
    ["top", 135,  15, "top"],
    ["top", 140,  20, "top"],
    ["top", 145,  25, "top"],
    ["top", 150,  30, "top"],
    ["top", 155,  35, "top"],
    ["top", 160,  40, "top"],
    ["top", 165,  45, "top"],
    ["top", 170,  50, "top"],
    ["top", 175,  55, "top"],
    ["top", 180,  60, "top"],
    ["top", 185,  65, "top"],
    ["top", 190,  70, "top"],
    ["top", 195,  75, "top"],
    ["top", 200,  80, "top"],
    ["top", 205,  85, "top"],
    ["top", 210, -90, "bottom"],
    ["top", 215, -85, "bottom"],
    ["top", 220, -80, "bottom"],
    ["top", 225, -75, "bottom"],
    ["top", 230, -70, "bottom"],
    ["top", 235, -65, "bottom"],
    ["top", 240, -60, "bottom"],
    ["top", 245, -55, "bottom"],
    ["top", 250, -50, "bottom"],
    ["top", 255, -45, "bottom"],
    ["top", 260, -40, "bottom"],
    ["top", 265, -35, "bottom"],
    ["top", 270, -30, "bottom"],
    ["top", 275, -25, "bottom"],
    ["top", 280, -20, "bottom"],
    ["top", 285, -15, "bottom"],
    ["top", 290, -10, "bottom"],
    ["top", 295,  -5, "bottom"],
    ["top", 300,   0, "bottom"],
    ["top", 305,   5, "bottom"],
    ["top", 310,  10, "bottom"],
    ["top", 315,  15, "bottom"],
    ["top", 320,  20, "bottom"],
    ["top", 325,  25, "bottom"],
    ["top", 330,  30, "bottom"],
    ["top", 335,  35, "bottom"],
    ["top", 340,  40, "bottom"],
    ["top", 345,  45, "bottom"],
    ["top", 350,  50, "bottom"],
    ["top", 355,  55, "bottom"],
    ["corner",   0,   0, "bottom"],
    ["corner",   5,   5, "bottom"],
    ["corner",  10,  10, "bottom"],
    ["corner",  15,  15, "bottom"],
    ["corner",  20,  20, "bottom"],
    ["corner",  25,  25, "bottom"],
    ["corner",  30,  30, "bottom"],
    ["corner",  35,  35, "bottom"],
    ["corner",  40,  40, "bottom"],
    ["corner",  45,  45, "bottom"],
    ["corner",  50,  50, "bottom"],
    ["corner",  55,  55, "bottom"],
    ["corner",  60,  60, "bottom"],
    ["corner",  65,  65, "bottom"],
    ["corner",  70,  70, "bottom"],
    ["corner",  75,  75, "bottom"],
    ["corner",  80,  80, "bottom"],
    ["corner",  85,  85, "bottom"],
    ["corner",  90,  90, "bottom"],
    ["corner",  95, -85, "top"],
    ["corner", 100, -80, "top"],
    ["corner", 105, -75, "top"],
    ["corner", 110, -70, "top"],
    ["corner", 115, -65, "top"],
    ["corner", 120, -60, "top"],
    ["corner", 125, -55, "top"],
    ["corner", 130, -50, "top"],
    ["corner", 135, -45, "top"],
    ["corner", 140, -40, "top"],
    ["corner", 145, -35, "top"],
    ["corner", 150, -30, "top"],
    ["corner", 155, -25, "top"],
    ["corner", 160, -20, "top"],
    ["corner", 165, -15, "top"],
    ["corner", 170, -10, "top"],
    ["corner", 175,  -5, "top"],
    ["corner", 180,   0, "top"],
    ["corner", 185,   5, "top"],
    ["corner", 190,  10, "top"],
    ["corner", 195,  15, "top"],
    ["corner", 200,  20, "top"],
    ["corner", 205,  25, "top"],
    ["corner", 210,  30, "top"],
    ["corner", 215,  35, "top"],
    ["corner", 220,  40, "top"],
    ["corner", 225,  45, "top"],
    ["corner", 230,  50, "top"],
    ["corner", 235,  55, "top"],
    ["corner", 240,  60, "top"],
    ["corner", 245,  65, "top"],
    ["corner", 250,  70, "top"],
    ["corner", 255,  75, "top"],
    ["corner", 260,  80, "top"],
    ["corner", 265,  85, "top"],
    ["corner", 270, -90, "bottom"],
    ["corner", 275, -85, "bottom"],
    ["corner", 280, -80, "bottom"],
    ["corner", 285, -75, "bottom"],
    ["corner", 290, -70, "bottom"],
    ["corner", 295, -65, "bottom"],
    ["corner", 300, -60, "bottom"],
    ["corner", 305, -55, "bottom"],
    ["corner", 310, -50, "bottom"],
    ["corner", 315, -45, "bottom"],
    ["corner", 320, -40, "bottom"],
    ["corner", 325, -35, "bottom"],
    ["corner", 330, -30, "bottom"],
    ["corner", 335, -25, "bottom"],
    ["corner", 340, -20, "bottom"],
    ["corner", 345, -15, "bottom"],
    ["corner", 350, -10, "bottom"],
    ["corner", 355,  -5, "bottom"],
]


class DummyAxes:
    corners = None
    _labelrotation = None


class DummyTernaryAxis:
    axis_name = 't'
    axes = DummyAxes


def _create_axis(rotation):
    from scipy.special import cosdg, sindg
    corners = np.array([
        (0.5, 1.0),
        (0.5 - 1.0 / np.sqrt(3.0), 0.0),
        (0.5 + 1.0 / np.sqrt(3.0), 0.0),
    ])
    rotation_matrix = ([
        [cosdg(rotation), -sindg(rotation)],
        [sindg(rotation),  cosdg(rotation)],
    ])
    self = DummyTernaryAxis()
    self.axes.corners = np.dot(rotation_matrix, corners.T).T
    self.axes.transAxes = IdentityTransform()
    return self


@pytest.mark.parametrize('label_position,rotation,label_rotation_ref,va_ref',
                         expected)
def test_get_label_position(label_position, rotation, label_rotation_ref,
                            va_ref):
    self = _create_axis(rotation)
    self.label_position = label_position
    label_rotation, va = TernaryAxis._get_label_rotation(self)
    assert np.isclose(label_rotation, label_rotation_ref) and va == va_ref


def _create_references():
    for position in ['bottom', 'top', 'corner']:
        for rotation in range(0, 360, 5):
            self = _create_axis(rotation)
            self.label_position = position
            label_rotation, va = TernaryAxis._get_label_rotation(self)
            print('    [{:s}, {:3.0f}, {:3.0f}, {:s}],'.format(
                '"' + position + '"', rotation, label_rotation,
                '"' + va + '"'))

if __name__ == '__main__':
    _create_references()
